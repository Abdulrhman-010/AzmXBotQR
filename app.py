import os
import qrcode
import io
from slack_bolt import App
from slack_bolt.adapter.socket_mode import SocketModeHandler
from datetime import datetime
import logging
from dotenv import load_dotenv

# ุชุญููู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ูู .env
load_dotenv()

# ุฅุนุฏุงุฏ ุงูุชุณุฌูู
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ุงูุญุตูู ุนูู Tokens ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ
SLACK_BOT_TOKEN = os.environ.get("SLACK_BOT_TOKEN")
SLACK_SIGNING_SECRET = os.environ.get("SLACK_SIGNING_SECRET")
SLACK_APP_TOKEN = os.environ.get("SLACK_APP_TOKEN")

# ุงูุชุญูู ูู ูุฌูุฏ Tokens
if not all([SLACK_BOT_TOKEN, SLACK_SIGNING_SECRET, SLACK_APP_TOKEN]):
    logger.error("โ ุฎุทุฃ: Tokens ุบูุฑ ููุฌูุฏุฉ ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ!")
    exit(1)

# ุฅูุดุงุก ุงูุชุทุจูู
app = App(token=SLACK_BOT_TOKEN, signing_secret=SLACK_SIGNING_SECRET)

# ===== ุฑุณุงุฆู ุงูุชุฑุญูุจ ูุงููุฌุงุญ =====
DEVELOPER_INFO = {
    'name': 'ุนุจุฏุงูุฑุญูู ุงูุนุฒู',
    'email': 'aalanzi@azmx.sa',
    'purpose': 'ุชุณููู ุชุญููู ุงูุฑูุงุจุท ุฅูู ุจุงุฑููุฏ ุจุฏูู ุงุณุชุนูุงู ููุงูุน ุฎุงุฑุฌูุฉ',
    'initiative': 'ูุจุงุฏุฑุฉ ุดุฎุตูุฉ ุบูุฑ ุฑุณููุฉ โจ',
    'version': 'v3.0',
    'date': 'ุฏูุณูุจุฑ 2025'
}

WELCOME_MESSAGES = [
    "๐ ุฒูุฏูู ุจุงูุฑุงุจุท ูุณุฃุญููู ูุจุงุฑููุฏ ุจูุญุธุฉ! โจ",
    "๐ ุฃููุงู! ุงูุด ุงูุฑุงุจุท ุงููู ุชุจููุ ๐",
    "๐ ุฃูุง ุฌุงูุฒ! ููู ูู ุงูุฑุงุจุท ูุฃูุง ุจุญููู!",
    "โจ ูุฑุญุจุง ูุง ุตุฏูู! ุฌููุฒ ุงูุฑุงุจุท ูุงุชุฑู ุงูุจุงูู ุนููู! ๐ฅ",
    "๐ซ ููุง ูุงููู! ุฃูุง ููุง ูุชุญููู ุฑูุงุจุทู ุจุณุฑุนุฉ ุงูุจุฑู!",
]

SUCCESS_MESSAGES = [
    "โ ููููู ุณุนูุฏ! 3> ูุฐุง ุจุงุฑููุฏู ุงูุฌุฏูุฏ",
    "๐ ูุจุฑูููู! ุงูุจุงุฑููุฏ ุฌุงูุฒ ูู ุจุงูุชูุงู ๐ฅ",
    "๐ ุชูุงู ุงูุชูุงู! ุจุงุฑููุฏู ุนูุฏู ุงูุขู",
    "๐ ุญุงุถุฑ! ุงูุจุงุฑููุฏ ุตุงุฑ ูุนู!",
    "๐ ููุง! ุงูุจุงุฑููุฏ ุฌุงูุฒ ููุง ูุตูุฑ!",
]

ERROR_MESSAGES = [
    "๐ ูุง ุตุฏูู! ุงูุฑุงุจุท ูุง ูุจุฏู ุตุญูุญ.. ุญุงูู ุชุชุฃูุฏ ูู ุงูุตูุบุฉ! ๐",
    "๐ค ูุนุฐุฑุฉุ ุงูุฑุงุจุท ููู ูุดููุฉ ุตุบูุฑุฉ ุชุฃูุฏ ุฃูู ููุชุญ ูุนู! ๐ฑ",
    "โ๏ธ ุงูุฑุงุจุท ูุง ุงุดุชุบู ูุนู! ุญุงูู ุชุชุฃูุฏ ุฃูู ุตุญูุญ ูุฌุฑุจ ูู ุฌุฏูุฏ! โจ",
    "๐ ุขุณูุ ุงูุฑุงุจุท ููู ุฎุทุฃ ูุง ุงุฎุชุจุฑู ูู ุงููุชุตูุญ ูุชุฃูุฏ ุฅูู ูุนูู! ๐",
    "๐ญ ุงูุฑุงุจุท ูุง ูุตูุฑ ูุนู ููุฃุณู! ุชุฃูุฏ ูู ุฃูู ูุณุฎุชู ุจุดูู ุตุญูุญ! ๐",
]

import random

# ===== ูุนุงูุฌ ุงูุฃูุงูุฑ =====

@app.command("/qr")
def handle_qr_command(ack, command, client):
    """ูุนุงูุฌ ุฃูุฑ QR ุงูุฑุฆูุณู"""
    ack()
    
    url = command.get("text", "").strip()
    
    if not url:
        client.chat_postMessage(
            channel=command["channel_id"],
            text="โ๏ธ ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑุงุจุท! ูุซุงู: `/qr https://google.com`"
        )
        return
    
    # ุงูุชุญูู ูู ุตูุบุฉ ุงูุฑุงุจุท
    if not url.startswith(("http://", "https://")):
        url = "https://" + url
    
    try:
        # ุฅูุดุงุก QR Code
        qr = qrcode.QRCode(
            version=1,
            error_correction=qrcode.constants.ERROR_CORRECT_L,
            box_size=10,
            border=4,
        )
        qr.add_data(url)
        qr.make(fit=True)
        
        # ุชุญููู ุงูุตูุฑุฉ ูู PNG
        img = qr.make_image(fill_color="black", back_color="white")
        
        # ุญูุธ ูู ุฐุงูุฑุฉ
        img_byte_arr = io.BytesIO()
        img.save(img_byte_arr, format='PNG')
        img_byte_arr.seek(0)
        
        # ุฑุณุงูุฉ ุงููุฌุงุญ ุงูุนุดูุงุฆูุฉ
        success_msg = random.choice(SUCCESS_MESSAGES)
        
        # ุฑูุน ุงูุตูุฑุฉ
        response = client.files_upload_v2(
            channel=command["channel_id"],
            file=img_byte_arr,
            filename="qrcode.png",
            title=f"QR Code - {url[:30]}...",
            initial_comment=f"{success_msg}\n๐ ุงูุฑุงุจุท: `{url}`"
        )
        
        logger.info(f"โ ุชู ุฅูุดุงุก QR Code ููุฑุงุจุท: {url}")
        
    except Exception as e:
        error_msg = random.choice(ERROR_MESSAGES)
        logger.error(f"โ ุฎุทุฃ ูู ุฅูุดุงุก QR Code: {str(e)}")
        client.chat_postMessage(
            channel=command["channel_id"],
            text=f"{error_msg}\n\n๐ ุงูุชูุงุตูู: `{str(e)}`"
        )

@app.command("/help")
def handle_help_command(ack, command, client):
    """ูุนุงูุฌ ุฃูุฑ ุงููุณุงุนุฏุฉ"""
    ack()
    
    help_text = """
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   ๐ค ูุณุงุนุฏุฉ ุจูุช AzmX - QR (v3.0)            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ **ุงูุฃูุงูุฑ ุงููุชุงุญุฉ:**

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
1๏ธโฃ **/qr [ุฑุงุจุท]** - ุชุญููู ุงูุฑุงุจุท ูุจุงุฑููุฏ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

   ๐ก **ุงูุงุณุชุฎุฏุงู:**
   /qr https://google.com
   /qr www.youtube.com
   /qr google.com (ุงูุจูุช ูุถูู https ุชููุงุฆูุงู)

   โจ **ุฃูุซูุฉ:**
   โข /qr https://wohaj.org
   โข /qr bit.ly/example
   โข /qr rb.gy/xyz

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
2๏ธโฃ **/about** - ูุนูููุงุช ุงูุจูุช ูุงููุทูุฑ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
3๏ธโฃ **/how-to** - ุฏููู ุดุงูู ุงูุงุณุชุฎุฏุงู
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
4๏ธโฃ **/support [ุงููุดููุฉ]** - ุทูุจ ุฏุนู
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

   ูุซุงู: /support ุงูุจุงุฑููุฏ ูุง ูุธูุฑ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ูุตูุญุฉ: ุงุณุชุฎุฏู ุงูุจูุช ุจูู ุจุฑุงุญุชู! ๐
    """
    
    client.chat_postMessage(
        channel=command["channel_id"],
        text=help_text
    )

@app.command("/how-to")
def handle_how_to_command(ack, command, client):
    """ูุนุงูุฌ ุฃูุฑ ุทุฑููุฉ ุงูุงุณุชุฎุฏุงู"""
    ack()
    
    how_to_text = """
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   ๐ ุทุฑููุฉ ุงูุงุณุชุฎุฏุงู - ุฏููู ุดุงูู            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ฏ ุงูููุฑุฉ ุงูุฃุณุงุณูุฉ:
ุญูู ุฃู ุฑุงุจุท ุฅูู ุตูุฑุฉ QR Code ุจุถุบุทุฉ ุฒุฑ! ๐ฑ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ุฎุทูุงุช ุงูุงุณุชุฎุฏุงู ุงูุฃุณุงุณูุฉ:

โ ุงูุฎุทูุฉ 1๏ธโฃ: ุงูุชุจ ุงูุฃูุฑ
   ุงูุชุจ ูู ูุฑุจุน ุงูุฑุณุงูุฉ: /qr

โ ุงูุฎุทูุฉ 2๏ธโฃ: ุฃุถู ุงูุฑุงุจุท
   ุจุนุฏ /qr ุถุน ูุณุงูุฉ ุซู ุงูุฑุงุจุท:
   /qr https://google.com

โ ุงูุฎุทูุฉ 3๏ธโฃ: ุงุถุบุท Enter
   ุณูุธูุฑ ุงูุจุงุฑููุฏ ููุฑุงู! โจ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ป ุฃูุซูุฉ ุนูููุฉ:

๐ ูุซุงู 1: ุฑุงุจุท ูููุน
   /qr https://www.wohaj.org
   
๐ ูุซุงู 2: ุฑุงุจุท ููุฏูู YouTube
   /qr https://www.youtube.com/watch?v=dQw4w9WgXcQ

๐ ูุซุงู 3: ุฑุงุจุท ูุตูุฑ
   /qr https://bit.ly/3xK9pL2

๐ ูุซุงู 4: ุฑุงุจุท ุจุฏูู https (ุงูุจูุช ูุถููู ุชููุงุฆูุงู)
   /qr google.com
   โ ูุตูุฑ: /qr https://google.com

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐จ ุงููุชูุฌุฉ ุงูุชู ุณุชุญุตู ุนูููุง:

ุจุนุฏ ูุง ุชูุชุจ ุงูุฃูุฑุ ุงูุจูุช ุณูุฑุณู:
โจ ุตูุฑุฉ QR Code ุนุงููุฉ ุงูุฌูุฏุฉ
๐ ุงูุฑุงุจุท ุงููู ุญููุชู
โ ุฑุณุงูุฉ ูุฌุงุญ ุฌูููุฉ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โก ูุตุงุฆุญ ูููุฉ:

๐น ุงูุฑูุงุจุท ุงูุทูููุฉ: ุชููู ุจุดูู ุทุจูุนู
๐น ุงูุฑูุงุจุท ุงููุฎุชุตุฑุฉ: ุชูุฌุญ ุจุณุฑุนุฉ ุฃูุซุฑ
๐น ุงูุฑุงุจุท ุจุฏูู http: ูุง ูุดููุฉ! ุงูุจูุช ูุถููู ุชููุงุฆูุงู
๐น ุงุณุชุฎุฏูู ูู ุฃู ููุงุฉ: Public ุฃู Private

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ ุฃุณุฆูุฉ ุดุงุฆุนุฉ:

ุณ: ูู ุงูุจุงุฑููุฏ ููุชูู ุตูุงุญูุชูุ
ุฌ: ูุง! ุงูุจุงุฑููุฏ ูุจูู ุฃุจุฏุงู โ

ุณ: ูู ูููู ุงุณุชุฎุฏุงูู ุนุฏุฏ ูุฑุงุช ุบูุฑ ูุญุฏูุฏุ
ุฌ: ูุนู! ุงุณุชุฎุฏูู ููุง ุชุฑูุฏ ๐

ุณ: ูู ููุงู ุญุฏ ุฃูุตู ูุนุฏุฏ ุงูุฃูุงูุฑุ
ุฌ: ูุงุ ุงุณุชุฎุฏู ุงูุจูุช ุจุญุฑูุฉ ุชุงูุฉ!

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    """
    
    client.chat_postMessage(
        channel=command["channel_id"],
        text=how_to_text
    )

@app.command("/about")
def handle_about_command(ack, command, client):
    """ูุนุงูุฌ ุฃูุฑ ูุนูููุงุช ุงูุจูุช ูุงููุทูุฑ"""
    ack()
    
    about_text = f"""
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โน๏ธ ูุนูููุงุช ุจูุช AzmX - QR Code Generator   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ฑ **ุงูุจูุช:** AzmX - QR Code Generator
๐ง **ุงูุฅุตุฏุงุฑ:** {DEVELOPER_INFO['version']}
๐ **ุงูุชุงุฑูุฎ:** {DEVELOPER_INFO['date']}
๐จโ๐ป **ุงููุทูุฑ:** {DEVELOPER_INFO['name']}
๐ง **ุงูุจุฑูุฏ:** {DEVELOPER_INFO['email']}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โก **ุงููุฏู ุงูุฃุณุงุณู:**

{DEVELOPER_INFO['purpose']}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ **ุชูููู ููู:**

{DEVELOPER_INFO['initiative']}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โจ **ุงูููุฒุงุช:**

โ ุชุญููู ููุฑู ููุฑูุงุจุท (ุฃูู ูู ุซุงููุฉ)
โ ููุจู ุฌููุน ุตูุบ ุงูุฑูุงุจุท (http, https, www)
โ ุฌูุฏุฉ ุนุงููุฉ ุฌุฏุงู ููุจุงุฑููุฏ
โ ูุนูู 24/7 ุจุฏูู ุชููู
โ ูุฌุงูู 100% ุจุฏูู ุงุดุชุฑุงูุงุช
โ ุฑุณุงุฆู ูุฏูุฉ ุจุงูููุฌุฉ ุงูุณุนูุฏูุฉ
โ ุขูู ูููุซูู ุชูุงูุงู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ **ุงูุฃูุงูุฑ ุงููุชุงุญุฉ:**

1๏ธโฃ /qr [ุฑุงุจุท]    - ุชุญููู ุงูุฑุงุจุท ูุจุงุฑููุฏ
2๏ธโฃ /help         - ุนุฑุถ ุงููุณุงุนุฏุฉ
3๏ธโฃ /about        - ูุฐู ุงูุฑุณุงูุฉ
4๏ธโฃ /how-to       - ุฏููู ุงูุงุณุชุฎุฏุงู
5๏ธโฃ /support      - ุทูุจ ุงูุฏุนู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ก **ููููุงุญุธุงุช ูุงูุฃุฎุทุงุก:**
๐ง ุชูุงุตู ูุน: {DEVELOPER_INFO['email']}

    """
    
    client.chat_postMessage(
        channel=command["channel_id"],
        text=about_text
    )

@app.command("/support")
def handle_support_command(ack, command, client):
    """ูุนุงูุฌ ุฃูุฑ ุงูุฏุนู ุงูููู"""
    ack()
    
    issue = command.get("text", "").strip()
    user_id = command.get("user_id")
    
    if not issue:
        client.chat_postMessage(
            channel=command["channel_id"],
            text="โ๏ธ ุงูุฑุฌุงุก ูุตู ุงููุดููุฉ! ูุซุงู: `/support ุงูุจุงุฑููุฏ ูุง ูุธูุฑ`"
        )
        return
    
    try:
        # ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุดูุฑ ูููุณุชุฎุฏู
        client.chat_postMessage(
            channel=command["channel_id"],
            text="โ ุดูุฑุงู ูู! ุชู ุงุณุชูุงู ุทูุจ ุงูุฏุนู. ุณุฃุชูุงุตู ูุนู ูุฑูุจุงู ๐"
        )
        logger.info(f"๐ฌ ุทูุจ ุฏุนู ุฌุฏูุฏ ูู {user_id}: {issue}")
    except Exception as e:
        logger.error(f"โ ุฎุทุฃ ูู ุฅุฑุณุงู ุทูุจ ุงูุฏุนู: {str(e)}")

@app.event("app_mention")
def handle_mention(ack, event, client):
    """ูุนุงูุฌ ุฐูุฑ ุงูุจูุช"""
    ack()
    
    channel_id = event["channel"]
    welcome_msg = random.choice(WELCOME_MESSAGES)
    
    client.chat_postMessage(
        channel=channel_id,
        text=f"{welcome_msg}\n\n๐ฌ ููุจุฏุกุ ุงูุชุจ: `/how-to`\n๐ ูููุณุงุนุฏุฉุ ุงูุชุจ: `/help`"
    )

# ===== ูุนุงูุฌ ุงูุฃุฎุทุงุก =====
@app.error
def custom_error_handler(error, body, logger):
    """ูุนุงูุฌ ุงูุฃุฎุทุงุก ุงูุนุงู"""
    logger.exception(f"โ ุญุฏุซ ุฎุทุฃ: {error}")
    logger.debug(f"ุงูุทูุจ: {body}")

# ===== ุจุฏุก ุงูุจูุช =====
if __name__ == "__main__":
    logger.info("๐ ุฌุงุฑู ุชุดุบูู ุจูุช AzmX - QR...")
    handler = SocketModeHandler(app, SLACK_APP_TOKEN)
    handler.start()
    logger.info("โ ุงูุจูุช ูุนูู ุงูุขู! ๐")
